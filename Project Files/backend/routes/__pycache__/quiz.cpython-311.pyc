ยง
    Yรฅ[h  รฃ                   รณรข   โ d dl mZmZ d dlmZ d dlmZ d dl Z d dlZd dl	Z	d dl
Z
 eยฆ   ยซ           eddgยฌ ยฆ  ยซ        Z
 G dโ d	eยฆ  ยซ        Zd
โ Z
e
ย                    d
ยฆ  ยซ        defd
โยฆ   ยซ         ZdS )รฉ    )ร	APIRouterร
HTTPException)ร	BaseModel)ร
load_dotenvNz/quizรQuiz)รprefixรtagsc                   รณ$   โ e Zd ZU eed<   eed<   dS )ร
QuizRequestรtopicร
num_questionsN)ร__name__ร
__module__ร__qualname__รstrร__annotations__รintยฉ รณ    รบBC:\Users\navya\OneDrive\Desktop\edututor-ai\backend\routes\quiz.pyr
   r
      s'   โฌ โฌ โฌ โฌ โฌ โฌ ร
โฌJโฌJยJรรรรรรr   r
   c                  รณรข   โ d} ddi}t          j        dยฆ  ยซ        ddล}t          j        | ||ยฌ ยฆ  ยซ        }|j        dk    r|ย                    ยฆ   ยซ         d	         S t
          d
|j         โบ ยยฆ  ยซ        โ)
Nz(https://iam.cloud.ibm.com/identity/tokenรบContent-Typez!application/x-www-form-urlencodedรWATSONX_API_KEYz&urn:ibm:params:oauth:grant-type:apikey)รapikeyร
grant_type)ร headersรdataรฉร   รaccess_tokenzFailed to get IBM token: )รosรgetenvรrequestsรpostร
status_codeรjsonร	Exceptionรtext)รurlr   r   รresponses       r   ร
get_ibm_tokenr*      sย   โฌ ร
4โฌCรรBรCโฌGรฅโ)ร-ร.ร.ร>รฐรฐ โฌDรต ล}หSยจ'ยธร=ร=ร=โฌHร ร หsร "ร "รย}ล}โฐลห~ร.ร.รฅรCยฐHยดMรCรCรDรDรDr   z	/generateร payloadc                 รณร  โ d| j         โบ dย}d|โบ d| j        โบ dย}t          ยฆ   ยซ         }t           j        dยฆ  ยซ        โบ d ย}d|โบ ยd	d
ล}t           j        d
ยฆ  ยซ        |dd
dลt           j        dยฆ  ยซ        dล}t
          j        |||ยฌยฆ  ยซ        } | j         dk    ยrH	 | ย                    ยฆ   ยซ         d         d         d         }t          |t          t          fยฆ  ยซ        r	|d         }	n|}	t          d|	ยฆ  ยซ         t          j        d|	t          j        ยฆ  ยซ        }
|
st!          dยฆ  ยซ        โ|
ย                    dยฆ  ยซ        }
	 	 t          j        |
ยฆ  ยซ        }nV# t          j        $ rC |
ย                    ยฆ   ยซ         d dโฆ         }
t+          |
ยฆ  ยซ        dk     rt-          ddยฌยฆ  ยซ        โY nw xY wลld|iS # t.          $ r&}
t-          dd t1          |
ยฆ  ยซ        โบ ยยฌยฆ  ยซ        โd }
~
ww xY wd S )!Nz)This is some basic content on the topic: รบ.z/Use the following content to generate a quiz:

z


Generate af   multiple choice questions (MCQs). For each question, include:
- 'question': the text of the question
- 'options': a list of 4 answer choices
- 'answer': the correct answer
Return ONLY a valid JSON array of question objects. No explanation. No markdown. No code block.
Do not wrap it in a Python tuple or return extra text. Do not truncate the last question.รWATSONX_ENDPOINTz)/ml/v1/text/generation?version=2023-05-29z Bearer zapplication/json)ร
Authorizationr   รWATSONX_MODEL_IDรgreedyiร  )รdecoding_methodรmax_new_tokensรWATSONX_PROJECT_ID)รmodel_idรinputร
parametersร
project_id)r   r%   r   ร resultsr   รgenerated_textu   รฐลธโย WatsonX output:
z\[\s*{.*?}\s*\]z,No valid JSON array found in WatsonX output.Tรฉรฟรฟรฟรฟรฉ
   iรด  zOutput too corrupted to parse.)r$   รdetailร	questionsz Failed to parse WatsonX output: )r   r
   r*   r    r!   r"   r#   r$   r%   ร
isinstanceรtupleรlistรprintรreรsearchรDOTALLร
ValueErrorรgroupรloadsรJSONDecodeErrorรstripรlenr   r&   r   )r+   รcourse_materialsรpromptร	ibm_tokenr(   r   รpayload_datar)   ร
raw_outputรraw_textรmatchรcleaned_json_strr>   รes                 r   ร
generate_quizrU   $   sv  โฌ รฐH Tร7ร=รSรSรSรรฐ	eร
รฐ	eรฐ 	eรร)รฐ	eรฐ 	eรฐ 	eรฐ 
รต โโโฌIร
ลYร)ร
*ร
*ร
Uร
Uร
UโฌCร.ย9ร.ร.ร*รฐรฐ โฌGรต
 โIร0ร1ร1รร'ร"รฐ
รฐ 
รต โiร 4ร5ร5รฐรฐ โฌLรต ล}หSยจ'ยธรEรEรEโฌHร ร หsร "ร "รฐ	eร!ลธลกโขลยจร3ยฐAร6ร7GรHหJรห*ยฅuยญdยmร4ร4รฐ 
&ร%ยaล=ยยร%ยรร*ยจHร5ร5ร5รฅโIร0ยฐ(ยฝBยผIรFรFหEรรฐ 
Qร ร!OรPรPรPร$ลธ{ลก{ยจ1โข~ล~รรฐ 
fรฐfร $ยค
ร+;ร <ร <ยIรรธรร+รฐ fรฐ fรฐ fร'7ร'=ร'=ร'?ร'?รรรร'Dร$รร+ร,ร,ยจrร1ร1ร+ยธรDdรeรeรeรeรฐ 2ร1รฐfรธรธรธรฐ	 
fรฐ  ยร+ร+รธรฅรฐ 	eรฐ 	eรฐ 	eรยจCร8cร[^ร_`ร[aร[aร8cร8cรdรdรdรdรธรธรธรธรฐ	eรธรธรธรฐ1 #ร "s>   รB$F- ร>E รF- รAF%ร"F- ร$F%ร% F- ร-
Gร7!GรG)ร fastapir   r   รpydanticr   รdotenvr   r    r"   r%   rC   ร
quiz_routerr
   r*   r#   rU   r   r   r   รบ<module>rZ      s  รฐร ,ร ,ร ,ร ,ร ,ร ,ร ,ร ,ร ร ร ร ร ร ร ร ร ร ร ร รฐ 
โฌ	โฌ	โฌ	ร โฌโฌโฌร 
โฌ
โฌ
โฌ
ร 	โฌ	โฌ	โฌ	รฐ โฌ
ย
โ
โฌ
รหiร
ร
หรฐรฑ รด โฌ
รฐ
รฐ รฐ รฐ รฐ ย)รฑ รด รฐ รฐ
Eรฐ 
Eรฐ 
Eรฐ 
รรย+รรรฐ\eห;รฐ \eรฐ \eรฐ \eรฑ รรฐ\eรฐ \eรฐ \er   
